#!/bin/bash

TEST=1

rsyncmessage() {
    NEW='s/^>f+++++++++ /NEW /g'
    UPD="s/^>f..t.*\ /UPD /g"
    DEL='s/^\*deleting.*\ /DEL /g'
    if [ $1 == 1 ]; then
        LOC="s/^/SYSTEM /g"
    else
        LOC="s/^/SERVER /g"
    fi
    DIR='s/^c.*\ /DIR /g'
    GARBAGE='/^\.\|^sen\|^tot\|^$/d'
    sed "$DEL; $NEW; $UPD; $DIR; $GARBAGE; $LOC"
}

colorize(){
    SYS='s/^SYSTEM/\\e[38;5;47mSYSTEM\\e[0m/g'
    SER='s/^SERVER/\\e[38;5;226mSERVER\\e[0m/g'
    DEL='s/DEL/\\e[38;5;1mDEL\\e[0m/g'
    NEW='s/NEW/\\e[38;5;202mNEW\\e[0m/g'
    UPD='s/UPD/\\e[38;5;239mUPD\\e[0m/g'
    DIR='s/DIR/\\e[38;5;129mDIR\\e[0m/g'
    while read in; do
        echo -e "$(echo $in | sed "$DEL; $SYS; $SER; $NEW; $UPD; $DIR")";
    done
}
LOCAL="$HOME/Study"
SERVER="arsricharan@access2.cmi.ac.in:~/Study"
if [ $TEST == 1 ]; then
    SERVER="$HOME/Teddy"
fi
VSYNC="rsync --modify-window=1 --human-readable --recursive --links --perms --times --partial --progress --itemize-changes --verbose"
NOTDONE=true
ARRAY=($LOCAL $SERVER)
DIRECTION=0 # Direction 0 is LOCAL to SERVER, and 1 is SERVER to LOCAL
DELETEV=true # Delete 1 means deletions are on.
BOTH=true # Update from both sides
SYNC="$VSYNC"
QUESTION=(remove add)

while $NOTDONE; do
    if $BOTH; then
        $VSYNC $LOCAL/ $SERVER --update --dry-run | rsyncmessage 0 | colorize
        $VSYNC $SERVER/ $LOCAL --update --dry-run | rsyncmessage 1 | colorize
        read -p "Would you like to apply these changes [y/N]? Q to quit: " option
        case $option in
            [Yy]*)
                echo "Applying above-mentioned changes."
                $VSYNC $LOCAL/ $SERVER --update | rsyncmessage 0 | colorize
                $VSYNC $SERVER/ $LOCAL --update | rsyncmessage 1 | colorize
                NOTDONE=false
                ;;
            [Qq]*)
                exit
                ;;
            *)
                BOTH=false
                ;;
        esac
    else
        for arg in delete update; do
            echo "$SYNC" | grep "$arg"
            exists=$?
            read -p "Would you like to ${QUESTION[$exists]} the --$arg option[y/N]" option
            case $option in
                [Yy]*)
                    if [ $exists == 0 ]; then
                        SYNC=$(echo "$SYNC" | sed "s/ --$arg//g")
                    else
                        SYNC="$SYNC --$arg"
                    fi
                    ;;
                *)
                    ;;
            esac
        done
        read -p "To go back to dual-way transfers type [Bb], to swap the focus of deletion [Ff], to quit [Qq]." option
        case $option in
            [Bb]*)
                echo "Going back to dual-way transfers."
                BOTH=true
                ;;
            [Ff]*)
                echo "Swapping the focus of deletion."
                DIRECTION=$(expr 1 - $DIRECTION)
                ;;
            [Qq]*)
                NOTDONE=false
                return
                ;;
            *)
                ;;
        esac
        START=${ARRAY[$DIRECTION]}
        END=${ARRAY[1 - $DIRECTION]}
        $SYNC $START/ $END --dry-run | rsyncmessage $DIRECTION | colorize
        read -p "Would you like to apply these changes? [y/N]" option
        case $option in
            [Yy]*)
                echo "Applying above-mentioned changes."
                $SYNC $START/ $END  | rsyncmessage $DIRECTION | colorize
                NOTDONE=false
                ;;
            *)
                ;;
        esac

    fi
done

